/*
 * Syscall for the Linux kernel
 */

#define ARG_1 8
#define ARG_2 12
#define ARG_3 16
#define ARG_4 20
#define ARG_5 24

.text
	.Lsyscall:
		pushl %ebp
		movl %esp, %ebp

		pushl %ebx
		pushl %ecx
		pushl %edx
		pushl %esi
		pushl %edi

		/*
		 * On x86 the Linux kernel expects the syscall number to be
		 * passed to %eax and the parameters to %ebx, %ecx, %edx, %esi,
		 * %edi and %ebp.
		 */
		movl ARG_1(%ebp), %ebx
		movl ARG_2(%ebp), %ecx
		movl ARG_3(%ebp), %edx
		movl ARG_4(%ebp), %esi
		movl ARG_5(%ebp), %edi
		int $0x80

		cmpl $0, %eax
		jl .Lerror
		jmp .Lreturn
	.Lerror:
		negl %eax
		movl %eax, _errno
		movl $-1, %eax
	.Lreturn:
		popl %edi
		popl %esi
		popl %edx
		popl %ecx
		popl %ebx

		movl %ebp, %esp
		popl %ebp
		ret

/*
 * The file syscalls.S is generated by makesyscalls.sh. For each syscall,
 * an entry is created using syscalls.S.template that sets the syscall number
 * in the %eax register.
 */
#include "gen/syscalls.S"
